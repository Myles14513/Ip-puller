<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Device Info Auto Submit</title>
</head>
<body>
  <h1>Device Info Collector</h1>

  <!-- Netlify form -->
  <form name="device-info" netlify netlify-honeypot="bot-field" hidden>
    <input type="hidden" name="form-name" value="device-info">
    <input type="hidden" name="deviceInfo" id="deviceInfo">
  </form>

  <p id="status"></p>

<script>
async function fetchJSON(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Network response was not ok");
    return await res.json();
  } catch(e) {
    console.error("Failed to fetch", url, e);
    return { error: "Unavailable" };
  }
}

async function gatherDeviceInfo() {
  let info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    language: navigator.language,
    screen: { w: screen.width, h: screen.height, cd: screen.colorDepth },
    viewport: { w: window.innerWidth, h: window.innerHeight },
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    online: navigator.onLine,
    cookiesEnabled: navigator.cookieEnabled,
    timestamp: new Date().toISOString(),
    ip: { v4: {}, v6: {} }
  };

  // Fetch IPs
  const ipv4 = await fetchJSON("https://api.ipify.org?format=json");
  const ipv6 = await fetchJSON("https://api64.ipify.org?format=json");

  info.ip.v4.address = ipv4.ip || "Unavailable";
  info.ip.v6.address = ipv6.ip || "Unavailable";

  // Fetch Geo info for both
  if (info.ip.v4.address !== "Unavailable") {
    info.ip.v4.geo = await fetchJSON(`https://ipapi.co/${info.ip.v4.address}/json/`);
  } else {
    info.ip.v4.geo = { error: "Unavailable" };
  }

  if (info.ip.v6.address !== "Unavailable") {
    info.ip.v6.geo = await fetchJSON(`https://ipapi.co/${info.ip.v6.address}/json/`);
  } else {
    info.ip.v6.geo = { error: "Unavailable" };
  }

  return info;
}

const statusEl = document.getElementById("status");

window.addEventListener("load", async () => {
  const data = await gatherDeviceInfo();

  // Fill hidden input with JSON string
  document.getElementById("deviceInfo").value = JSON.stringify(data);

  // Submit to Netlify
  const form = document.forms["device-info"];
  fetch("/", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams(new FormData(form)).toString()
  })
  .then(() => {
    statusEl.textContent = "✅ Info (including IPs + geo) sent automatically.";
  })
  .catch(err => {
    console.error(err);
    statusEl.textContent = "❌ Failed to send.";
  });
});
</script>
</body>
</html>